#!/bin/bash
#
# MySQL Backup Script
#  Dumps mysql databases to a file for another backup tool to pick up.
#
# MySQL code:
# GRANT SELECT, RELOAD, LOCK TABLES ON *.* TO 'user'@'localhost'
# IDENTIFIED BY 'password';
# FLUSH PRIVILEGES;
#
##### START CONFIG ###################################################

# point to file with credentials for mysql and mysqldump
DEFAULTS_EXTRA_FILE=<%= scope.lookupvar('restic::restic_path') %>/mysqlpasswd
PREFIX=mysql

# exclude system db's if requested
#<% if scope.lookupvar('restic::mysqlexcludesystemdb') == true -%>
#FILTER='| grep -vwe ("information_schema|mysql|performance_schema") '
#<% end -%>

# Create mysql backup directory if needed
DIR=<%= scope.lookupvar('restic::backuprootfolder') %>/mysql
mkdir -p $DIR

# Use docker-compose if requested
<% if scope.lookupvar('restic::docker_compose') == true -%>
CMD="cd scope.lookupvar('restic::docker_compose_dir') && docker-compose exec <%= scope.lookupvar('restic::docker_container') %>"
<% else -%>
CMD=""
<% end -%>

##### STOP CONFIG ####################################################
PATH=/usr/bin:/usr/sbin:/bin:/sbin

set -o pipefail

<% if scope.lookupvar('restic::mysqlalldatabases') == true -%>
  <% if scope.lookupvar('restic::mysqlfileperdatabase') == true -%>
    ${CMD} mysql --defaults-extra-file=${DEFAULTS_EXTRA_FILE} -s -r -N -e 'SHOW DATABASES' 2>>/var/log/restic/prebackup.log ${FILTER} | while read dbname
    do
    ${CMD} mysqldump --defaults-extra-file=${DEFAULTS_EXTRA_FILE} --opt --flush-logs --single-transaction \
      ${EVENTS} \
      ${dbname} 2>>/var/log/restic/prebackup.log | gzip -c 2>>/var/log/restic/prebackup.log > ${DIR}/${PREFIX}_${dbname}.sql.gz
    done
  <% else -%>
    ${CMD} mysqldump --defaults-extra-file=${DEFAULTS_EXTRA_FILE} --opt --flush-logs --single-transaction --all-databases 2>>/var/log/restic/prebackup.log | gzip -c 2>>/var/log/restic/prebackup.log > ${DIR}/${PREFIX}.sql.gz
  <% end -%>
<% else -%>
  <% if scope.lookupvar('restic::mysqlfileperdatabase') == true -%>
    <% scope.lookupvar('restic::mysqldatabasearray').each do |db| -%>
      ${CMD} mysqldump --defaults-extra-file=${DEFAULTS_EXTRA_FILE} --opt --flush-logs --single-transaction --databases <%=db %> 2>>/var/log/restic/prebackup.log | gzip -c 2>>/var/log/restic/prebackup.log > ${DIR}/${PREFIX}_<%=db %>.sql.gz
    <% end -%>
  <% else -%>
    ${CMD} mysqldump --defaults-extra-file=${DEFAULTS_EXTRA_FILE} --opt --flush-logs --single-transaction --databases <% scope.lookupvar('restic::mysqldatabasearray').each do |db| -%><%=db %> <% end -%> 2>>/var/log/restic/prebackup.log | gzip -c 2>>/var/log/restic/prebackup.log > ${DIR}/${PREFIX}.sql.gz
  <% end -%>
<% end -%>





